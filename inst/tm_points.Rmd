---
title: "Terraforming Mars Tussenstand"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"
)
library(dplyr)

games_df <- tm::get_data()
attacks_df <- tm::get_attacks()
milestones_df <- tm::get_milestones()
cards_df <- tm::get_cards()

last_season <- games_df %>%
  filter(season_n == max(season_n))

last_game <- last_season %>%
  filter(game_n == max(game_n))

last_attacks <- attacks_df %>%
  filter(season_n == max(season_n)) %>%
  filter(game_n == max(game_n))
```

## Results {.tabset}

### Laatste Game

```{r}
last_game <- last_game %>%
  tidyr::pivot_longer(cols = c(score, rank), names_to = "names")

plotly::plot_ly(
  last_game, x = ~player, y = ~round(value, 2),
  type = 'bar', color = ~names
  #, colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
) %>%
  plotly::layout(
    title = 'Punten',
    yaxis = list(title = 'punten'),
    xaxis = list(title = 'speler', categoryorder = 'total descending'),
    barmode = 'stack'
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
last_attacks %>%
  group_by(target, resource) %>%
  summarise(amount = sum(amount)) %>%
  plotly::plot_ly(
    x = ~target, y = ~amount, type = 'bar', split = ~resource
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Grootste stumper',
    yaxis = list(title = 'aantal gestolen resources'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
last_attacks %>%
  group_by(source, resource) %>%
  summarise(amount = sum(amount)) %>%
  plotly::plot_ly(
    x = ~source, y = ~amount, type = 'bar', split = ~resource
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Grootste naaier',
    yaxis = list(title = 'aantal gestolen resources'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

### Huidige Seizoen

```{r}
alpha <- 1
last_season %>%
  mutate(magic_total = average_points + alpha * average_rank) %>%
  plotly::plot_ly(
    x = ~as.integer(game_n), y = ~round(magic_total, 2), color = ~player, 
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100"),
    type = 'scatter', mode = 'lines'
  ) %>%
  plotly::layout(
    title = 'Gecombineerde ranking na een spel',
    yaxis = list(title = 'magische ranking'),
    xaxis = list(title = 'spel nummer')
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
last_season %>%
  filter(rank == 10) %>%
  count(player, corporation) %>%
  plotly::plot_ly(
    x = ~player, y = ~n, color = ~corporation, type = 'bar'
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Aantal overwinningen per speler',
    yaxis = list(title = 'aantal overwinningen'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

### History

Zie hier de huidige tussenstand. Eerst het aantal punten per speler, deze punten zijn geschaald tussen 0 en het puntenaantal van de winnaar.

```{r}
games_df %>%
  arrange(game_id) %>%
  group_by(player) %>%
  mutate(
    average_rank = cumsum(rank),
    average_points = cumsum(score)
  ) %>%
  plotly::plot_ly(
    x = ~game_id, y = ~round(average_points + average_rank, 2),
    type = 'scatter', mode = 'lines', color = ~player, 
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    title = 'All-time Ranking',
    yaxis = list(title = 'punten'),
    xaxis = list(title = 'spel')
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
season_1 <- tibble::tibble(
  player = c(rep("Paul", 4), rep("Dennis", 3), "Wim", "Bas"),
  corporation = "Season 1",
  n = c(rep(1, 8), 0.8),
  rank = 10
)
```

```{r}
games_df %>%
  filter(rank == 10) %>%
  count(player, corporation) %>%
  dplyr::bind_rows(season_1) %>%
  plotly::plot_ly(
    x = ~player, y = ~n, color = ~corporation, type = 'bar'
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Aantal overwinningen per speler',
    yaxis = list(title = 'aantal overwinningen'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
games_df %>%
  dplyr::bind_rows(season_1) %>%
  mutate(rank = (10 - rank) / 5 * 2 + 1) %>%
  count(player, rank) %>%
  plotly::plot_ly(
    x = ~rank, y = ~n, color = ~player, type = 'bar',
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    title = 'Resultaat per speler',
    yaxis = list(title = 'aantal keer per positie'),
    xaxis = list(title = 'positie', range = 5:1, categoryorder = "total descending")
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

#### Cards

```{r}
cards_df %>%
  count(player, name) %>%
  group_by(name) %>%
  mutate(total = sum(n)) %>%
  filter(total > 10) %>%
  plotly::plot_ly(
    x = ~name, y = ~n, type = 'bar', color = ~player,
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Gespeelde kaarten (>10)',
    yaxis = list(title = 'aantal keer gespeeld'),
    xaxis = list(
      title = 'kaart', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

Meest gespeelde kaarten per speler:

```{r}
cards_df %>%
  count(player, name) %>%
  group_by(player) %>%
  arrange(desc(n)) %>%
  slice(1:5)
```

```{r}
cards_df %>%
  filter(name == "Toll Station") %>%
  count(player) %>%
  plotly::plot_ly(
    x = ~player, y = ~n, type = 'bar', color = ~player,
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Het zou verboden moeten worden...',
    yaxis = list(title = 'aantal keer Toll Station gespeeld'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```


#### Milestones

```{r}
milestones_df %>%
  count(player, milestone) %>%
  plotly::plot_ly(
    x = ~milestone, y = ~n, type = 'bar', color = ~player,
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Geclaimde milestones',
    yaxis = list(title = 'aantal geclaimt'),
    xaxis = list(
      title = 'milestone', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
milestones_df %>%
  count(player) %>%
  plotly::plot_ly(
    x = ~player, y = ~n, type = 'bar', color = ~player,
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Geclaimde milestones per speler',
    yaxis = list(title = 'aantal geclaimt'),
    xaxis = list(
      title = 'player', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
tibble::tibble(
  player = c("Paul", "Wim", "Rudo", "Bas", "Dennis"),
  n = c(1, 2, 0, 0, 0)
) %>%
  plotly::plot_ly(
    x = ~player, y = ~n, type = 'bar', color = ~player,
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Aantal seizoenen gewonnen',
    yaxis = list(title = 'aantal overwinningen'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

#### Corporations

Nog wat extra corporation info. Dit is het gemiddelde aantal punten per corporation:

```{r}
games_df %>%
  group_by(corporation) %>%
  summarise(average_corp_points = mean(score_org)) %>%
  plotly::plot_ly(
    x = ~corporation, y = ~average_corp_points, type = 'bar'
  ) %>%
  plotly::layout(
    title = 'Gemiddeld aantal punten per corporation',
    yaxis = list(title = 'corporation'),
    xaxis = list(
      title = 'gemiddeld aantal punten', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

En het aantal overwinningen per corporation:

```{r}
games_df %>%
  group_by(player) %>%
  filter(rank == 10) %>%
  count(corporation) %>%
  plotly::plot_ly(
    x = ~corporation, y = ~n, color = ~player, type = 'bar', 
    colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Aantal overwinningen per corporation',
    yaxis = list(title = 'aantal overwinningen'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

En hoe vaak een corperation gekozen wordt:

```{r}
games_df %>%
  count(corporation) %>%
  filter(n > 1) %>%
  plotly::plot_ly(
    x = ~corporation, y = ~n, type = 'bar'
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Aantal keer gespeeld per corporation',
    yaxis = list(title = 'aantal keer gespeeld'),
    xaxis = list(
      title = 'corperation', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

#### Attacks

```{r}
attacks_df %>%
  group_by(target, resource) %>%
  summarise(amount = sum(amount)) %>%
  plotly::plot_ly(
    x = ~target, y = ~amount, type = 'bar', split = ~resource
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Grootste stumper All-time',
    yaxis = list(title = 'aantal gestolen resources'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
attacks_df %>%
  group_by(source, resource) %>%
  summarise(amount = sum(amount)) %>%
  plotly::plot_ly(
    x = ~source, y = ~amount, type = 'bar', split = ~resource
  ) %>%
  plotly::layout(
    barmode = 'stack',
    title = 'Grootste naaier All-time',
    yaxis = list(title = 'aantal gestolen resources'),
    xaxis = list(
      title = 'speler', categoryorder = "total descending"
    )
  ) %>%
  plotly::config(displayModeBar = FALSE)
```

```{r}
# games_df %>%
#   count(player, start_order) %>%
#   plotly::plot_ly(
#     x = ~start_order, y = ~n, color = ~player, type = 'bar',
#     colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100")
#   ) %>%
#   plotly::layout(
#     barmode = 'stack',
#     title = 'Beurtvolgorder eerste generatie',
#     yaxis = list(title = 'speler'),
#     xaxis = list(title = 'beurtvolgorde')
#   ) %>%
#   plotly::config(displayModeBar = FALSE)
```

```{r}
# games_df %>%
#   plotly::plot_ly(
#     x = ~as.integer(game_n), y = ~average_start_order, color = ~player, 
#     colors = c("#AAAA00", "#009900", "#0066FF", "#AAAAAA", "#991100"),
#     type = 'scatter', mode = 'lines'
#   ) %>%
#   plotly::layout(
#     title = 'Gemiddelde start volgorde, lager is eerder aan de beurt',
#     yaxis = list(title = 'volgorde'),
#     xaxis = list(title = 'spel nummer')
#   ) %>%
#   plotly::config(displayModeBar = FALSE)
```

#### Undo

De volgende spelers hebben als enige een undo via de database gedaan, hebben daar grote voordelen mee behaald en verdienen het onder een demos down terecht te komen: **Paul** en **Wim**. Ook een vermelding voor **Bas**, na eerst gestemd te hebben voor de no-undo policy, wachte hij wel tot de server op dinsdag avond gereset werd om een move ongedaan te maken...
